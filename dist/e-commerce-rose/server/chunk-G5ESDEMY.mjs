import './polyfills.server.mjs';
import{a as ue}from"./chunk-CRL6SIVF.mjs";import{b as ee,c as O,d as te,e as ie,i as ne,l as oe,m as re,u as se,w as ae}from"./chunk-YRG62QXE.mjs";import{a as pe}from"./chunk-666L3XN7.mjs";import{c as Y,d as J,f as L,i as X,o as de}from"./chunk-VP43NVKH.mjs";import{$c as ce,Aa as R,Ab as p,Cc as K,Fa as d,La as k,M as _,Ma as r,Oa as I,Oc as Q,Sc as Z,U as v,V as h,W as C,X as E,Xa as s,Xc as W,Ya as a,Za as g,Zc as le,_c as me,ab as b,ad as ge,bb as x,cb as m,cc as N,dc as $,ec as H,gb as B,hb as j,ia as M,ib as U,kb as u,kc as q,lb as w,mb as P,nb as V,oc as z,qc as y,ra as F,tb as D,ub as T,va as o,vb as A,wb as G,zb as c}from"./chunk-UQC3G75Y.mjs";import"./chunk-X2SEQXRR.mjs";var ve=["commentsContainer"],fe=n=>({"space-x-reverse":n}),he=(n,t,i)=>["/",n,"policies",t,i],Ce=()=>[1,2,3],xe=(n,t)=>({"ms-auto":n,"me-auto":t});function ye(n,t){n&1&&(s(0,"div",23)(1,"div",24),g(2,"div",25),s(3,"div",26),g(4,"div",27)(5,"div",28),a()(),g(6,"hr",29),a())}function be(n,t){n&1&&(s(0,"div",22),d(1,ye,7,0,"div",11),a()),n&2&&(o(),r("ngForOf",D(1,Ce)))}function we(n,t){if(n&1&&(s(0,"div",30),u(1),a()),n&2){let i=m();o(),w(i.error)}}function Pe(n,t){n&1&&(s(0,"div",31),u(1),c(2,"translate"),a()),n&2&&(o(),P(" ",p(2,1,"pages.comments.no_comments")," "))}function Ie(n,t){n&1&&(s(0,"div",39),g(1,"img",40),c(2,"translate"),a()),n&2&&(o(),r("alt",p(2,1,"pages.comments.images.admin_avatar")))}function Se(n,t){n&1&&(s(0,"div",39),g(1,"img",41),c(2,"translate"),a()),n&2&&(o(),r("alt",p(2,1,"pages.comments.images.user_avatar")))}function Fe(n,t){if(n&1&&(s(0,"div",42)(1,"a",43),C(),s(2,"svg",44),g(3,"path",45),a(),u(4),c(5,"translate"),a()()),n&2){let i=m().$implicit,e=m();o(),r("href",e.API_CONFIG.BASE_URL_IMAGE+i.fileUrl,F),o(3),P(" ",p(5,2,"pages.comments.view_file")," ")}}function Te(n,t){if(n&1&&g(0,"hr",46),n&2){let i=m().$implicit,e=m();r("ngClass",A(1,xe,i.role=="user"&&!e.isRTL||i.role!=="user"&&e.isRTL,i.role!=="user"&&!e.isRTL||i.role=="user"&&e.isRTL))}}function Le(n,t){if(n&1&&(s(0,"div",23)(1,"div",32)(2,"div",33),d(3,Ie,3,3,"div",34)(4,Se,3,3,"div",34),a(),s(5,"div",26)(6,"span",35),u(7),a(),s(8,"div",36),u(9),a(),d(10,Fe,6,4,"div",37),a()(),d(11,Te,1,4,"hr",38),a()),n&2){let i=t.$implicit,e=t.last,l=m();o(),r("ngClass",l.getAlignmentClasses(i.role)),o(2),r("ngIf",i.role!="user"),o(),r("ngIf",i.role==="user"),o(3),V(" ",i.sender," \xB7 ",i.date," "),o(2),P(" ",i.message," "),o(),r("ngIf",i.fileUrl),o(),r("ngIf",!e)}}function Oe(n,t){if(n&1&&(g(0,"img",53),c(1,"translate")),n&2){let i=m().$implicit,e=m(2);r("src",e.getFilePreview(i),F)("alt",p(1,2,"pages.comments.images.file_preview"))}}function Ee(n,t){n&1&&(C(),s(0,"svg",44),g(1,"path",45),a())}function Me(n,t){if(n&1){let i=b();s(0,"button",54),x("click",function(){v(i);let l=m().index,f=m(2);return h(f.removeFile(l))}),C(),s(1,"svg",55),g(2,"line",56)(3,"line",57),a()()}}function Re(n,t){if(n&1&&(s(0,"div",49),d(1,Oe,2,4,"img",50)(2,Ee,2,0,"svg",51),u(3),d(4,Me,4,0,"button",52),a()),n&2){let i=t.$implicit,e=m(2);o(),r("ngIf",e.isImageFile(i)),o(),r("ngIf",!e.isImageFile(i)),o(),P(" ",i.name," "),o(),r("ngIf",!e.isSubmitting)}}function ke(n,t){if(n&1&&(s(0,"div",23)(1,"div",47),d(2,Re,5,4,"div",48),a()()),n&2){let i=m();o(2),r("ngForOf",i.selectedFiles)}}function Be(n,t){if(n&1){let i=b();s(0,"button",58),c(1,"translate"),x("click",function(){v(i);let l=m();return h(l.triggerFileInput())}),C(),s(2,"svg",59),g(3,"path",45),a()()}if(n&2){let i=m();r("disabled",!i.canComment),k("title",p(1,2,"pages.comments.attach_files"))}}function je(n,t){n&1&&(s(0,"span"),u(1),c(2,"translate"),a()),n&2&&(o(),w(p(2,1,"pages.comments.send")))}function Ue(n,t){n&1&&(s(0,"span"),u(1),c(2,"translate"),a()),n&2&&(o(),w(p(2,1,"pages.comments.sending")))}function Ve(n,t){if(n&1){let i=b();s(0,"input",60),x("change",function(l){v(i);let f=m();return h(f.onFileSelect(l))}),a()}}var _e=class n{route=_(Q);policiesService=_(ue);fb=_(se);languageService=_(de);authStorage=_(pe);platformId=_(M);translate=_(le);commentsContainer;policyId=null;policyType=null;comments=[];commentForm;isLoading=!0;isSubmitting=!1;error=null;currentLang$=this.languageService.currentLanguage$;isRTL=!1;selectedFiles=[];filePreviewUrls={};canComment=!1;receiver=null;API_CONFIG=ge;constructor(){this.commentForm=this.fb.group({message:["",[O.required,O.minLength(1)]]})}ngOnInit(){this.currentLang$.subscribe(t=>{this.isRTL=t==="ar"}),this.route.paramMap.subscribe(t=>{let i=t.get("policyId"),e=t.get("policyType");i&&e&&["medical","motor","building","jop","job"].includes(e)?(this.policyId=+i,this.policyType=e==="job"?"jop":e,this.fetchComments()):(this.error=this.translate.instant("pages.comments.errors.invalid_policy"),this.isLoading=!1)})}fetchComments(){!this.policyId||!this.policyType||this.policiesService.getPolicyWithComments(this.policyId,this.policyType).subscribe({next:t=>{this.comments=t.policy.comments.map(e=>({id:e.id,sender:e.user_name,date:this.formatDate(e.comment_date),message:e.comment,role:e.user_role,fileUrl:e.comment_file})),this.canComment=t.policy.active_status==="pending"&&t.policy.comments.length>0;let i=t.policy.comments.filter(e=>e.user_role!=="user").sort((e,l)=>new Date(l.comment_date).getTime()-new Date(e.comment_date).getTime())[0];i&&(this.receiver={id:i.user_id,role:i.user_role,name:i.user_name}),this.isLoading=!1,this.scrollToBottom()},error:t=>{this.error=this.translate.instant("pages.comments.errors.load_comments"),this.isLoading=!1,console.error("Error fetching comments:",t)}})}formatDate(t){return new Date(t).toLocaleString(this.languageService.getCurrentLanguage()==="ar"?"ar-EG":"en-US",{timeZone:"Africa/Cairo",day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})||this.translate.instant("pages.comments.na")}onFileSelect(t){if(!y(this.platformId))return;let i=t.target;i.files&&(this.selectedFiles=Array.from(i.files),this.selectedFiles.forEach(e=>{this.isImageFile(e)&&(this.filePreviewUrls[e.name]=URL.createObjectURL(e))}))}isImageFile(t){return t.type.startsWith("image/")}getFilePreview(t){return this.filePreviewUrls[t.name]||""}triggerFileInput(){if(!y(this.platformId))return;document.getElementById("fileInput")?.click()}removeFile(t){if(!y(this.platformId))return;let i=this.selectedFiles[t];this.filePreviewUrls[i.name]&&(URL.revokeObjectURL(this.filePreviewUrls[i.name]),delete this.filePreviewUrls[i.name]),this.selectedFiles.splice(t,1)}onKeyDown(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.onSubmit())}onSubmit(){if(!this.canComment||!this.commentForm.valid||!this.receiver||!this.policyId||!this.policyType)return;this.isSubmitting=!0;let t=this.authStorage.getUserData();if(!t){this.error=this.translate.instant("pages.comments.errors.not_authenticated"),this.isSubmitting=!1;return}let i={user_id:t.id,user_role:t.role,user_name:t.name,comment:this.commentForm.get("message")?.value.trim(),reciver_id:this.receiver.id,reciver_role:this.receiver.role,reciver_name:this.receiver.name,request_id:this.policyId,request_status:"pending",comment_file:this.selectedFiles.length>0?this.selectedFiles[0]:null};(this.policyType==="medical"?this.policiesService.createMedicalPolicyComment(this.policyId,i):this.policyType==="motor"?this.policiesService.createMotorPolicyComment(this.policyId,i):this.policyType==="jop"?this.policiesService.createJopPolicyComment(this.policyId,i):this.policiesService.createBuildingPolicyComment(this.policyId,i)).subscribe({next:l=>{if(l instanceof K){this.commentForm.reset(),Object.values(this.filePreviewUrls).forEach(S=>URL.revokeObjectURL(S)),this.filePreviewUrls={},this.selectedFiles=[];let f=document.getElementById("fileInput");f&&(f.value=""),this.isSubmitting=!1,this.fetchComments()}},error:l=>{this.error=this.translate.instant("pages.comments.errors.submit_comment"),this.isSubmitting=!1,console.error("Error submitting comment:",l)}})}scrollToBottom(){!y(this.platformId)||!this.commentsContainer||setTimeout(()=>{this.commentsContainer.nativeElement.scrollTop=this.commentsContainer.nativeElement.scrollHeight},0)}getAlignmentClasses(t){return this.isRTL?t==="user"?"":"flex-row-reverse":t==="user"?"flex-row-reverse":""}ngOnDestroy(){y(this.platformId)&&Object.values(this.filePreviewUrls).forEach(t=>URL.revokeObjectURL(t))}static \u0275fac=function(i){return new(i||n)};static \u0275cmp=R({type:n,selectors:[["app-comments-page"]],viewQuery:function(i,e){if(i&1&&B(ve,5),i&2){let l;j(l=U())&&(e.commentsContainer=l.first)}},decls:29,vars:50,consts:[["commentsContainer",""],[1,"p-6","bg-[#F8F8F8]","max-w-[1440px]","h-[70vh]","mx-auto","rounded-md","flex","flex-col",3,"dir"],[1,"flex","items-center","space-x-2","text-blue-600","font-medium","cursor-pointer","mb-4","flex-shrink-0",3,"ngClass"],[3,"routerLink"],["xmlns","http://www.w3.org/2000/svg","width","35","height","35","viewBox","0 0 35 35","fill","none"],["d","M17.499 2.97363C9.47637 2.97363 2.97266 9.47734 2.97266 17.5C2.97266 25.5227 9.47637 32.0264 17.499 32.0264C25.5217 32.0264 32.0254 25.5227 32.0254 17.5C32.0254 9.47734 25.5217 2.97363 17.499 2.97363ZM22.157 24.4863C22.585 24.9129 22.5856 25.6054 22.1591 26.0333C21.9451 26.2473 21.6648 26.3546 21.3846 26.3546C21.105 26.3546 20.8261 26.2479 20.6121 26.0354L12.841 18.2861C12.6353 18.0811 12.5197 17.8028 12.5197 17.5123C12.5197 17.2218 12.6346 16.9436 12.8403 16.7378L20.6121 8.96602C21.0394 8.53877 21.7318 8.53877 22.1591 8.96602C22.5863 9.39326 22.5863 10.0857 22.1591 10.513L15.1611 17.5103L22.157 24.4863Z","fill","#B2B2B2"],[1,"comments-updates"],[1,"flex-1","overflow-x-hidden","overflow-y-auto","min-h-0","mb-4"],["class","animate-pulse",4,"ngIf"],["class","text-red-600 text-center",4,"ngIf"],["class","text-gray-500 text-center",4,"ngIf"],["class","mb-4",4,"ngFor","ngForOf"],[1,"flex-shrink-0",3,"ngSubmit","formGroup"],["class","mb-4",4,"ngIf"],[1,"flex","items-end","gap-2",3,"ngClass"],[1,"relative","flex-grow","flex","items-center","flex-col"],["formControlName","message","rows","1",1,"w-full","px-4","py-2","pr-20","border","rounded-md","focus:outline-none","focus:ring-2","focus:ring-[#37A6DE]","resize-none",3,"keydown","placeholder","disabled","readOnly"],[1,"absolute","bottom-1/2","transform","translate-y-1/2","end-2","flex","items-center","gap-1"],["type","button","class","p-1 hover:bg-gray-100 rounded-full transition-colors duration-200",3,"disabled","click",4,"ngIf"],["type","submit",1,"flex","items-center","justify-center","px-3","py-1","bg-[#37A6DE]","text-white","rounded-md","hover:bg-blue-600","transition","disabled:cursor-not-allowed","text-sm",3,"disabled"],[4,"ngIf"],["type","file","id","fileInput","multiple","","class","hidden","accept",".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt",3,"change",4,"ngIf"],[1,"animate-pulse"],[1,"mb-4"],[1,"flex","items-start","gap-4"],[1,"w-12","h-12","rounded-full","bg-gray-200"],[1,"flex","flex-col","max-w-xl","gap-2"],[1,"h-4","w-32","bg-gray-200","rounded"],[1,"h-16","w-full","bg-gray-200","rounded-lg"],[1,"mt-4","text-[#b2b2b2b3]","max-w-sm","ms-auto"],[1,"text-red-600","text-center"],[1,"text-gray-500","text-center"],[1,"flex","items-start","gap-4",3,"ngClass"],[1,"flex","flex-col","items-center","flex-shrink-0"],["class","w-12 h-12 rounded-full bg-white shadow flex items-center justify-center",4,"ngIf"],[1,"sender-date","text-sm","text-gray-600"],[1,"comment-text","p-3","rounded-lg","whitespace-pre-wrap","break-words","leading-relaxed"],["class","flex justify-end flex-wrap gap-2 mt-2",4,"ngIf"],["class","mt-4 text-[#b2b2b2b3] max-w-sm",3,"ngClass",4,"ngIf"],[1,"w-12","h-12","rounded-full","bg-white","shadow","flex","items-center","justify-center"],["src","/assets/logo/logo.webp",1,"w-8","h-8","object-contain",3,"alt"],["src","/assets/policies/user-avatar.svg",1,"w-8","h-8","object-contain",3,"alt"],[1,"flex","justify-end","flex-wrap","gap-2","mt-2"],["target","_blank",1,"bg-white","px-3","py-1","rounded-full","text-sm","border","flex","items-center","gap-2",3,"href"],["xmlns","http://www.w3.org/2000/svg","width","16","height","16","viewBox","0 0 24 24","fill","none"],["d","M14.5625 11.0912L10.7321 15.1827C10.4072 15.5457 9.9448 15.7557 9.45756 15.7614C8.97037 15.767 8.50318 15.5678 8.16989 15.2124C7.43365 14.4439 7.44602 13.2279 8.19773 12.4745L13.3423 6.97275C13.9099 6.34099 14.7175 5.97797 15.5668 5.97304C16.4159 5.9681 17.2277 6.3217 17.8025 6.94683C19.0286 8.30174 19.0199 10.3678 17.7823 11.7123L12.3276 17.5404C11.5514 18.3197 10.4887 18.7453 9.38918 18.7175C8.28962 18.6897 7.24987 18.211 6.51389 17.3936C4.83165 15.496 4.87326 12.629 6.6099 10.7811L11.7622 5.28027","stroke","currentColor","stroke-linecap","round","stroke-linejoin","round"],[1,"mt-4","text-[#b2b2b2b3]","max-w-sm",3,"ngClass"],[1,"flex","flex-wrap","gap-2"],["class","bg-blue-50 px-3 py-2 rounded-lg flex items-center gap-2 text-sm",4,"ngFor","ngForOf"],[1,"bg-blue-50","px-3","py-2","rounded-lg","flex","items-center","gap-2","text-sm"],["class","w-10 h-10 object-cover rounded",3,"src","alt",4,"ngIf"],["xmlns","http://www.w3.org/2000/svg","width","16","height","16","viewBox","0 0 24 24","fill","none",4,"ngIf"],["type","button","class","text-red-500 hover:text-red-700 ml-2",3,"click",4,"ngIf"],[1,"w-10","h-10","object-cover","rounded",3,"src","alt"],["type","button",1,"text-red-500","hover:text-red-700","ml-2",3,"click"],["xmlns","http://www.w3.org/2000/svg","width","14","height","14","viewBox","0 0 24 24","fill","none","stroke","currentColor","stroke-width","2"],["x1","18","y1","6","x2","6","y2","18"],["x1","6","y1","6","x2","18","y2","18"],["type","button",1,"p-1","hover:bg-gray-100","rounded-full","transition-colors","duration-200",3,"click","disabled"],["xmlns","http://www.w3.org/2000/svg","width","20","height","20","viewBox","0 0 24 24","fill","none",1,"text-gray-500","hover:text-gray-700"],["type","file","id","fileInput","multiple","","accept",".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt",1,"hidden",3,"change"]],template:function(i,e){if(i&1){let l=b();s(0,"div",1)(1,"div",2)(2,"a",3),c(3,"async"),C(),s(4,"svg",4),g(5,"path",5),a()(),E(),s(6,"span",6),u(7),c(8,"translate"),a()(),s(9,"div",7,0),d(11,be,2,2,"div",8)(12,we,2,1,"div",9)(13,Pe,3,3,"div",10)(14,Le,12,8,"div",11),a(),s(15,"form",12),x("ngSubmit",function(){return v(l),h(e.onSubmit())}),d(16,ke,3,1,"div",13),s(17,"div",14)(18,"div",15)(19,"textarea",16),c(20,"translate"),c(21,"translate"),c(22,"translate"),x("keydown",function(S){return v(l),h(e.onKeyDown(S))}),a(),s(23,"div",17),d(24,Be,4,4,"button",18),s(25,"button",19),d(26,je,3,3,"span",20)(27,Ue,3,3,"span",20),a()()()(),d(28,Ve,1,0,"input",21),a()()}if(i&2){let l;r("dir",e.isRTL?"rtl":"ltr")("@fadeIn",void 0),o(),r("ngClass",T(42,fe,e.isRTL)),o(),r("routerLink",G(44,he,p(3,32,e.currentLang$),e.policyId,e.policyType)),o(2),I("rotate-180",e.isRTL),o(3),w(p(8,34,"pages.comments.header")),o(4),r("ngIf",e.isLoading),o(),r("ngIf",!e.isLoading&&e.error),o(),r("ngIf",!e.isLoading&&!e.error&&e.comments.length===0),o(),r("ngForOf",e.comments),o(),r("formGroup",e.commentForm),o(),r("ngIf",e.selectedFiles.length>0),o(),r("ngClass",T(48,fe,e.isRTL)),o(2),I("border-red-500",((l=e.commentForm.get("message"))==null?null:l.invalid)&&((l=e.commentForm.get("message"))==null?null:l.touched))("pr-20",!e.isRTL)("pl-20",e.isRTL),r("placeholder",e.canComment?p(20,36,"pages.comments.placeholder.add_comment"):e.comments.length===0?p(21,38,"pages.comments.placeholder.no_comments"):p(22,40,"pages.comments.placeholder.disabled"))("disabled",!e.canComment||e.isSubmitting)("readOnly",!e.canComment),o(4),I("right-2",!e.isRTL)("left-2",e.isRTL),o(),r("ngIf",!e.isSubmitting),o(),r("disabled",e.commentForm.invalid||!e.canComment||e.isSubmitting),o(),r("ngIf",!e.isSubmitting),o(),r("ngIf",e.isSubmitting),o(),r("ngIf",!e.isSubmitting)}},dependencies:[z,N,$,H,q,ae,ne,ee,te,ie,oe,re,W,Z,ce,me],styles:[".comments-updates[_ngcontent-%COMP%]{font-weight:500;color:#3b82f6}.sender-date[_ngcontent-%COMP%]{font-size:.875rem;color:#6b7280;font-weight:500}.comment-text[_ngcontent-%COMP%]{padding:12px 16px;border-radius:12px;line-height:1.5;word-wrap:break-word;max-width:100%}[dir=rtl][_ngcontent-%COMP%]   .flex-row-reverse[_ngcontent-%COMP%]{flex-direction:row-reverse}[dir=rtl][_ngcontent-%COMP%]   .text-end[_ngcontent-%COMP%]{text-align:end}[dir=rtl][_ngcontent-%COMP%]   .text-start[_ngcontent-%COMP%]{text-align:start}[dir=rtl][_ngcontent-%COMP%]   .space-x-reverse[_ngcontent-%COMP%] > *[_ngcontent-%COMP%] + *[_ngcontent-%COMP%]{margin-right:.5rem;margin-left:0}[dir=rtl][_ngcontent-%COMP%]   .ms-auto[_ngcontent-%COMP%]{margin-inline-start:auto}[dir=rtl][_ngcontent-%COMP%]   .me-auto[_ngcontent-%COMP%]{margin-inline-end:auto}@keyframes _ngcontent-%COMP%_slideIn{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.comment-enter[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slideIn .3s ease-out}.file-item[_ngcontent-%COMP%]{transition:all .2s ease}.file-item[_ngcontent-%COMP%]:hover{background-color:#eff6ff}@media (max-width: 640px){.comment-text[_ngcontent-%COMP%]{max-width:calc(100vw - 120px)}.flex.items-center.gap-2[_ngcontent-%COMP%]{flex-wrap:wrap}.flex-grow[_ngcontent-%COMP%]{min-width:200px}}input[type=text][_ngcontent-%COMP%]:focus{box-shadow:0 0 0 3px #3b82f61a}button[_ngcontent-%COMP%]:focus{outline:2px solid #3B82F6;outline-offset:2px}button[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}button[_ngcontent-%COMP%]:disabled:hover{background-color:#9ca3af!important}"],data:{animation:[Y("fadeIn",[X(":enter",[L({opacity:0}),J("0.5s ease-in-out",L({opacity:1}))])])]}})};export{_e as CommentsPageComponent};
