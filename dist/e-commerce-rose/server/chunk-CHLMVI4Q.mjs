import './polyfills.server.mjs';
import{a as de}from"./chunk-7QCG5OXL.mjs";import{b as X,c as R,d as Y,e as ee,i as te,l as ie,m as ne,u as re,w as se}from"./chunk-YRG62QXE.mjs";import{a as le}from"./chunk-666L3XN7.mjs";import{c as q,d as W,f as E,i as J,o as ce}from"./chunk-VP43NVKH.mjs";import{$c as oe,Aa as O,Ab as v,Cc as K,Fa as c,M as g,Ma as s,Oa as S,Oc as Q,Sc as z,U as _,V as C,W as h,X as j,Xa as a,Xc as Z,Ya as m,Za as p,Zc as ae,_c as me,ab as y,ad as pe,bb as x,cb as l,cc as M,dc as G,ec as N,gb as B,hb as P,ia as k,ib as V,kb as d,kc as $,lb as w,mb as I,nb as U,oc as H,qc as b,ra as L,tb as D,ub as F,va as r,vb as A,zb as f}from"./chunk-UQC3G75Y.mjs";import"./chunk-X2SEQXRR.mjs";var fe=["commentsContainer"],ue=n=>({"space-x-reverse":n}),ve=n=>["/",n,"claims"],_e=()=>[1,2,3],Ce=(n,t)=>({"ms-auto":n,"me-auto":t});function he(n,t){n&1&&(a(0,"div",23)(1,"div",24),p(2,"div",25),a(3,"div",26),p(4,"div",27)(5,"div",28),m()(),p(6,"hr",29),m())}function xe(n,t){n&1&&(a(0,"div",22),c(1,he,7,0,"div",11),m()),n&2&&(r(),s("ngForOf",D(1,_e)))}function be(n,t){if(n&1&&(a(0,"div",30),d(1),m()),n&2){let i=l();r(),w(i.error)}}function ye(n,t){n&1&&(a(0,"div",31),d(1),f(2,"translate"),m()),n&2&&(r(),I(" ",v(2,1,"pages.claims.comment.no_available")," "))}function we(n,t){n&1&&(a(0,"div",39),p(1,"img",40),m())}function Ie(n,t){n&1&&(a(0,"div",39),p(1,"img",41),m())}function Se(n,t){if(n&1&&(a(0,"div",42)(1,"a",43),h(),a(2,"svg",44),p(3,"path",45),m(),d(4),f(5,"translate"),m()()),n&2){let i=l().$implicit,e=l();r(),s("href",e.API_CONFIG.BASE_URL_IMAGE+i.comment_file,L),r(3),I(" ",v(5,2,"pages.claims.comment.view_attached_file")," ")}}function Fe(n,t){if(n&1&&p(0,"hr",46),n&2){let i=l().$implicit,e=l();s("ngClass",A(1,Ce,i.role=="user"&&!e.isRTL||i.role!=="user"&&e.isRTL,i.role!=="user"&&!e.isRTL||i.role=="user"&&e.isRTL))}}function Te(n,t){if(n&1&&(a(0,"div",23)(1,"div",32)(2,"div",33),c(3,we,2,0,"div",34)(4,Ie,2,0,"div",34),m(),a(5,"div",26)(6,"span",35),d(7),m(),a(8,"div",36),d(9),m(),c(10,Se,6,4,"div",37),m()(),c(11,Fe,1,4,"hr",38),m()),n&2){let i=t.$implicit,e=t.last,o=l();r(),s("ngClass",o.getAlignmentClasses(i.role)),r(2),s("ngIf",i.role==="admin"),r(),s("ngIf",i.role==="user"),r(3),U(" ",i.sender," \xB7 ",i.date," "),r(2),I(" ",i.message," "),r(),s("ngIf",i.comment_file),r(),s("ngIf",!e)}}function Le(n,t){if(n&1&&p(0,"img",53),n&2){let i=l().$implicit,e=l(2);s("src",e.getFilePreview(i),L)}}function Ee(n,t){n&1&&(h(),a(0,"svg",44),p(1,"path",45),m())}function Re(n,t){if(n&1){let i=y();a(0,"button",54),x("click",function(){_(i);let o=l().index,u=l(2);return C(u.removeFile(o))}),h(),a(1,"svg",55),p(2,"line",56)(3,"line",57),m()()}}function je(n,t){if(n&1&&(a(0,"div",49),c(1,Le,1,1,"img",50)(2,Ee,2,0,"svg",51),d(3),c(4,Re,4,0,"button",52),m()),n&2){let i=t.$implicit,e=l(2);r(),s("ngIf",e.isImageFile(i)),r(),s("ngIf",!e.isImageFile(i)),r(),I(" ",i.name," "),r(),s("ngIf",!e.isSubmitting)}}function ke(n,t){if(n&1&&(a(0,"div",23)(1,"div",47),c(2,je,5,4,"div",48),m()()),n&2){let i=l();r(2),s("ngForOf",i.selectedFiles)}}function Oe(n,t){if(n&1){let i=y();a(0,"button",58),f(1,"translate"),x("click",function(){_(i);let o=l();return C(o.triggerFileInput())}),h(),a(2,"svg",59),p(3,"path",45),m()()}if(n&2){let i=l();s("title",v(1,2,"pages.claims.comment.attache_file"))("disabled",!i.canComment)}}function Be(n,t){n&1&&(a(0,"span"),d(1),f(2,"translate"),m()),n&2&&(r(),w(v(2,1,"pages.comments.send")))}function Pe(n,t){n&1&&(a(0,"span"),d(1),f(2,"translate"),m()),n&2&&(r(),w(v(2,1,"pages.comments.sending")))}function Ve(n,t){if(n&1){let i=y();a(0,"input",60),x("change",function(o){_(i);let u=l();return C(u.onFileSelect(o))}),m()}}var ge=class n{route=g(Q);claimsService=g(de);fb=g(re);languageService=g(ce);authStorage=g(le);platformId=g(k);translate=g(ae);commentsContainer;claimId=null;claimType=null;comments=[];commentForm;isLoading=!0;isSubmitting=!1;error=null;currentLang$=this.languageService.currentLanguage$;isRTL=!1;selectedFiles=[];filePreviewUrls={};canComment=!1;receiver=null;API_CONFIG=pe;constructor(){this.commentForm=this.fb.group({message:["",[R.required,R.minLength(1)]]})}ngOnInit(){this.route.paramMap.subscribe(t=>{let i=t.get("claimId"),e=t.get("claimType");i&&e&&["medical","motor","building","jop","job"].includes(e)?(this.claimId=+i,this.claimType=e==="job"?"jop":e,this.fetchComments()):(this.error=this.translate.instant("pages.claims.comment.errors.invalid_claim_or_id"),this.isLoading=!1)}),this.currentLang$.subscribe(t=>{this.isRTL=t==="ar"})}fetchComments(){!this.claimId||!this.claimType||this.claimsService.getClaimWithComments(this.claimId,this.claimType).subscribe({next:t=>{this.comments=t.claim.comments.map(e=>({id:e.id,sender:e.user_name,date:this.formatDate(e.created_at),message:e.comment,role:e.user_role,comment_file:e.comment_file,claim_number:e.claim_number})),this.canComment=t.claim.status==="pending"&&t.claim.comments.length>0;let i=t.claim.comments.filter(e=>e.user_role!=="user").sort((e,o)=>new Date(o.created_at).getTime()-new Date(e.created_at).getTime())[0];i&&(this.receiver={id:i.user_id,role:i.user_role,name:i.user_name}),this.isLoading=!1,this.scrollToBottom()},error:t=>{this.error=this.translate.instant("pages.claims.comment.errors.failed_to_load"),this.isLoading=!1,console.error("Error fetching comments:",t)}})}formatDate(t){return t?new Date(t).toLocaleString("en-US",{timeZone:"Africa/Cairo",day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0}):"N/A"}onFileSelect(t){if(!b(this.platformId))return;let i=t.target;i.files&&(this.selectedFiles=Array.from(i.files),this.selectedFiles.forEach(e=>{this.isImageFile(e)&&(this.filePreviewUrls[e.name]=URL.createObjectURL(e))}))}isImageFile(t){return t.type.startsWith("image/")}getFilePreview(t){return this.filePreviewUrls[t.name]||""}triggerFileInput(){if(!b(this.platformId))return;document.getElementById("fileInput")?.click()}removeFile(t){if(!b(this.platformId))return;let i=this.selectedFiles[t];this.filePreviewUrls[i.name]&&(URL.revokeObjectURL(this.filePreviewUrls[i.name]),delete this.filePreviewUrls[i.name]),this.selectedFiles.splice(t,1)}onKeyDown(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.onSubmit())}onSubmit(){if(!this.canComment||!this.commentForm.valid||!this.receiver||!this.claimId||!this.claimType)return;this.isSubmitting=!0;let t=this.authStorage.getUserData();if(!t){this.error=this.translate.instant("pages.claims.comment.errors.user_not_auth"),this.isSubmitting=!1;return}let i={user_id:t.id,user_role:t.role,user_name:t.name,comment:this.commentForm.get("message")?.value.trim(),reciver_id:this.receiver.id,reciver_role:this.receiver.role,reciver_name:this.receiver.name,claim_id:this.claimId,claim_number:this.comments[0]?.claim_number||"",claim_status:"pending",comment_file:this.selectedFiles.length>0?this.selectedFiles[0]:null};(this.claimType==="medical"?this.claimsService.createMedicalClaimComment(this.claimId,i):this.claimType==="motor"?this.claimsService.createMotorClaimComment(this.claimId,i):this.claimType==="jop"?this.claimsService.createJopClaimComment(this.claimId,i):this.claimsService.createBuildingClaimComment(this.claimId,i)).subscribe({next:o=>{if(o instanceof K){this.commentForm.reset(),Object.values(this.filePreviewUrls).forEach(T=>URL.revokeObjectURL(T)),this.filePreviewUrls={},this.selectedFiles=[];let u=document.getElementById("fileInput");u&&(u.value=""),this.isSubmitting=!1,this.fetchComments()}},error:o=>{this.error=this.translate.instant("pages.claims.comment.errors.failed_to_submit"),this.isSubmitting=!1,console.error("Error submitting comment:",o)}})}scrollToBottom(){!b(this.platformId)||!this.commentsContainer||setTimeout(()=>{this.commentsContainer.nativeElement.scrollTop=this.commentsContainer.nativeElement.scrollHeight},0)}getAlignmentClasses(t){return this.isRTL?t==="user"?"":"flex-row-reverse":t==="user"?"flex-row-reverse":""}ngOnDestroy(){b(this.platformId)&&Object.values(this.filePreviewUrls).forEach(t=>URL.revokeObjectURL(t))}static \u0275fac=function(i){return new(i||n)};static \u0275cmp=O({type:n,selectors:[["app-comments-page"]],viewQuery:function(i,e){if(i&1&&B(fe,5),i&2){let o;P(o=V())&&(e.commentsContainer=o.first)}},decls:26,vars:42,consts:[["commentsContainer",""],[1,"p-6","max-w-[1440px]","bg-[#F8F8F8]","h-[70vh]","mx-auto","rounded-md","flex","flex-col",3,"dir"],[1,"flex","items-center","space-x-2","text-blue-600","font-medium","cursor-pointer","mb-4","flex-shrink-0",3,"ngClass"],[3,"routerLink"],["xmlns","http://www.w3.org/2000/svg","width","35","height","35","viewBox","0 0 35 35","fill","none"],["d","M17.499 2.97363C9.47637 2.97363 2.97266 9.47734 2.97266 17.5C2.97266 25.5227 9.47637 32.0264 17.499 32.0264C25.5217 32.0264 32.0254 25.5227 32.0254 17.5C32.0254 9.47734 25.5217 2.97363 17.499 2.97363ZM22.157 24.4863C22.585 24.9129 22.5856 25.6054 22.1591 26.0333C21.9451 26.2473 21.6648 26.3546 21.3846 26.3546C21.105 26.3546 20.8261 26.2479 20.6121 26.0354L12.841 18.2861C12.6353 18.0811 12.5197 17.8028 12.5197 17.5123C12.5197 17.2218 12.6346 16.9436 12.8403 16.7378L20.6121 8.96602C21.0394 8.53877 21.7318 8.53877 22.1591 8.96602C22.5863 9.39326 22.5863 10.0857 22.1591 10.513L15.1611 17.5103L22.157 24.4863Z","fill","#B2B2B2"],[1,"comments-updates"],[1,"flex-1","overflow-y-auto","overflow-x-hidden","min-h-0","mb-4"],["class","animate-pulse",4,"ngIf"],["class","text-red-600 text-center",4,"ngIf"],["class","text-gray-500 text-center",4,"ngIf"],["class","mb-4",4,"ngFor","ngForOf"],[1,"flex-shrink-0",3,"ngSubmit","formGroup"],["class","mb-4",4,"ngIf"],[1,"flex","items-end","gap-2",3,"ngClass"],[1,"relative","flex-grow","flex","items-center","flex-col"],["formControlName","message","rows","1",1,"w-full","px-4","py-2","pr-20","border","rounded-md","focus:outline-none","focus:ring-2","focus:ring-[#37A6DE]","resize-none",3,"keydown","placeholder","disabled","readOnly"],[1,"absolute","bottom-1/2","transform","translate-y-1/2","end-2","flex","items-center","gap-1"],["type","button","class","p-1 hover:bg-gray-100 rounded-full transition-colors duration-200",3,"title","disabled","click",4,"ngIf"],["type","submit",1,"flex","items-center","justify-center","px-3","py-1","bg-[#37A6DE]","text-white","rounded-md","hover:bg-blue-600","transition","disabled:cursor-not-allowed","text-sm",3,"disabled"],[4,"ngIf"],["type","file","id","fileInput","multiple","","class","hidden","accept",".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt",3,"change",4,"ngIf"],[1,"animate-pulse"],[1,"mb-4"],[1,"flex","items-start","gap-4"],[1,"w-12","h-12","rounded-full","bg-gray-200"],[1,"flex","flex-col","max-w-xl","gap-2"],[1,"h-4","w-32","bg-gray-200","rounded"],[1,"h-16","w-full","bg-gray-200","rounded-lg"],[1,"mt-4","text-[#b2b2b2b3]","max-w-sm","ms-auto"],[1,"text-red-600","text-center"],[1,"text-gray-500","text-center"],[1,"flex","items-start","gap-4",3,"ngClass"],[1,"flex","flex-col","items-center","flex-shrink-0"],["class","w-12 h-12 rounded-full bg-white shadow flex items-center justify-center",4,"ngIf"],[1,"sender-date","text-sm","text-gray-600"],[1,"comment-text","p-3","rounded-lg","whitespace-pre-wrap","break-words","leading-relaxed"],["class","flex justify-end flex-wrap gap-2 mt-2",4,"ngIf"],["class","mt-4 text-[#b2b2b2b3] max-w-sm",3,"ngClass",4,"ngIf"],[1,"w-12","h-12","rounded-full","bg-white","shadow","flex","items-center","justify-center"],["src","/assets/logo/logo.webp","alt","avatar",1,"w-8","h-8","object-contain"],["src","/assets/policies/user-avatar.svg","alt","avatar",1,"w-8","h-8","object-contain"],[1,"flex","justify-end","flex-wrap","gap-2","mt-2"],["target","_blank",1,"bg-white","px-3","py-1","rounded-full","text-sm","border","flex","items-center","gap-2",3,"href"],["xmlns","http://www.w3.org/2000/svg","width","16","height","16","viewBox","0 0 24 24","fill","none"],["d","M14.5625 11.0912L10.7321 15.1827C10.4072 15.5457 9.9448 15.7557 9.45756 15.7614C8.97037 15.767 8.50318 15.5678 8.16989 15.2124C7.43365 14.4439 7.44602 13.2279 8.19773 12.4745L13.3423 6.97275C13.9099 6.34099 14.7175 5.97797 15.5668 5.97304C16.4159 5.9681 17.2277 6.3217 17.8025 6.94683C19.0286 8.30174 19.0199 10.3678 17.7823 11.7123L12.3276 17.5404C11.5514 18.3197 10.4887 18.7453 9.38918 18.7175C8.28962 18.6897 7.24987 18.211 6.51389 17.3936C4.83165 15.496 4.87326 12.629 6.6099 10.7811L11.7622 5.28027","stroke","currentColor","stroke-linecap","round","stroke-linejoin","round"],[1,"mt-4","text-[#b2b2b2b3]","max-w-sm",3,"ngClass"],[1,"flex","flex-wrap","gap-2"],["class","bg-blue-50 px-3 py-2 rounded-lg flex items-center gap-2 text-sm",4,"ngFor","ngForOf"],[1,"bg-blue-50","px-3","py-2","rounded-lg","flex","items-center","gap-2","text-sm"],["alt","preview","class","w-10 h-10 object-cover rounded",3,"src",4,"ngIf"],["xmlns","http://www.w3.org/2000/svg","width","16","height","16","viewBox","0 0 24 24","fill","none",4,"ngIf"],["type","button","class","text-red-500 hover:text-red-700 ml-2",3,"click",4,"ngIf"],["alt","preview",1,"w-10","h-10","object-cover","rounded",3,"src"],["type","button",1,"text-red-500","hover:text-red-700","ml-2",3,"click"],["xmlns","http://www.w3.org/2000/svg","width","14","height","14","viewBox","0 0 24 24","fill","none","stroke","currentColor","stroke-width","2"],["x1","18","y1","6","x2","6","y2","18"],["x1","6","y1","6","x2","18","y2","18"],["type","button",1,"p-1","hover:bg-gray-100","rounded-full","transition-colors","duration-200",3,"click","title","disabled"],["xmlns","http://www.w3.org/2000/svg","width","20","height","20","viewBox","0 0 24 24","fill","none",1,"text-gray-500","hover:text-gray-700"],["type","file","id","fileInput","multiple","","accept",".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt",1,"hidden",3,"change"]],template:function(i,e){if(i&1){let o=y();a(0,"div",1)(1,"div",2)(2,"a",3),f(3,"async"),h(),a(4,"svg",4),p(5,"path",5),m()(),j(),a(6,"span",6),d(7),f(8,"translate"),m()(),a(9,"div",7,0),c(11,xe,2,2,"div",8)(12,be,2,1,"div",9)(13,ye,3,3,"div",10)(14,Te,12,8,"div",11),m(),a(15,"form",12),x("ngSubmit",function(){return _(o),C(e.onSubmit())}),c(16,ke,3,1,"div",13),a(17,"div",14)(18,"div",15)(19,"textarea",16),x("keydown",function(T){return _(o),C(e.onKeyDown(T))}),m(),a(20,"div",17),c(21,Oe,4,4,"button",18),a(22,"button",19),c(23,Be,3,3,"span",20)(24,Pe,3,3,"span",20),m()()()(),c(25,Ve,1,0,"input",21),m()()}if(i&2){let o;s("dir",e.isRTL?"rtl":"ltr")("@fadeIn",void 0),r(),s("ngClass",F(36,ue,e.isRTL)),r(),s("routerLink",F(38,ve,v(3,32,e.currentLang$))),r(2),S("rotate-180",e.isRTL),r(3),w(v(8,34,"pages.claims.comment.comment_and_update")),r(4),s("ngIf",e.isLoading),r(),s("ngIf",!e.isLoading&&e.error),r(),s("ngIf",!e.isLoading&&!e.error&&e.comments.length===0),r(),s("ngForOf",e.comments),r(),s("formGroup",e.commentForm),r(),s("ngIf",e.selectedFiles.length>0),r(),s("ngClass",F(40,ue,e.isRTL)),r(2),S("border-red-500",((o=e.commentForm.get("message"))==null?null:o.invalid)&&((o=e.commentForm.get("message"))==null?null:o.touched))("pr-20",!e.isRTL)("pl-20",e.isRTL),s("placeholder",e.canComment?e.translate.instant("pages.claims.comment.add_a_comment"):e.comments.length===0?e.translate.instant("pages.claims.comment.no_comment_available_to_replay"):e.translate.instant("pages.claims.comment.commenting_is_disabled"))("disabled",!e.canComment||e.isSubmitting)("readOnly",!e.canComment),r(),S("right-2",!e.isRTL)("left-2",e.isRTL),r(),s("ngIf",!e.isSubmitting),r(),s("disabled",e.commentForm.invalid||!e.canComment||e.isSubmitting),r(),s("ngIf",!e.isSubmitting),r(),s("ngIf",e.isSubmitting),r(),s("ngIf",!e.isSubmitting)}},dependencies:[H,M,G,N,$,se,te,X,Y,ee,ie,ne,Z,z,oe,me],encapsulation:2,data:{animation:[q("fadeIn",[J(":enter",[E({opacity:0}),W("0.5s ease-in-out",E({opacity:1}))])])]}})};export{ge as ClaimsCommentsComponent};
